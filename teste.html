<!DOCTYPE html>
<html>
    <head>
        
    </head>
    <body>
    
    
        
        <div id="cidade"></div>
    
    
    
     <script src="three.js"></script>
     <script src="orbit.js"></script>
     <script src="packer.growing.js"></script>
     <script src="packer.js"></script>    
     <script src="underscore.js"></script>    
        
     <script src="analise3.json"></script>    
        
    
     <script>
        
         
         function No(attrs, parent){
             if(attrs){
                this.package = attrs.package;
                this.attrs = attrs;
             }
             
             this.parent = parent;
             this.classes = {};
             this.packages = {};
             
             this.w = 0;
             this.h = 0;
         }
         
         No.prototype.updateClass2DSize = function(){
            this.w = this.getMetrica('LOC')+50;
            this.h = this.getMetrica('LOC')+50;             
         }
        
         No.prototype.getMetrica = function(metrica){
             if(this.attrs && this.attrs.classes && this.attrs.classes.length){
                 for(var i =0; i<=this.attrs.classes[0].metrics.length; i++){
                     if(this.attrs.classes[0].metrics[i].metric == metrica){
                         return this.attrs.classes[0].metrics[i].value;
                     }
                 }
             }
         }
         
         function ajustarPosicoesFilho(no){
             var classes = _.values(no.classes).concat(_.values(no.packages))
            
             for(var i = 0; i < classes.length; i++){
                 var elemento = classes[i];
                 if(elemento.fit){
                    elemento.fit.y = elemento.fit.y -(no.h/2) + (elemento.h/2);
                    elemento.fit.x = elemento.fit.x - (no.w/2) + (elemento.w/2); 
                 }
             }
         }
         
         function calcularBin(no){
              var classes = _.values(no.classes).concat(_.values(no.packages))
             classes.sort(function(a,b) { return (b.w > a.w); });
             
             //_.sortBy(classes, function(obj){ return obj.w });
             
             
                 var packer = new GrowingPacker();
                 packer.fit(classes);      
                 no.w = packer.root.w+50;
                 no.h = packer.root.h+50;
                 //ajustar pacotes
                 ajustarPosicoesFilho(no)
                
            
         }
         
         No.prototype.calcularPosicoes = function(no){
             if(_.values(no.packages).length == 0){
                 calcularBin(no)
           
             } else {
                 var packages = _.values(no.packages);
                 for(var i=0; i<packages.length; i++){
                     this.calcularPosicoes(packages[i])
                 }
                 calcularBin(no)
           
             }             
         }
         
         No.prototype.adicionar = function(no){
             
             var pacotes = no.package.split('.');
             
             if(this.packages[pacotes[0]]){
                 no.package = no.package.split('.').splice(1).join('.');
                 this.packages[pacotes[0]].adicionar(no);
             } 
             else if(pacotes.length == 1 && pacotes[0]!=''){
                 no.package = pacotes[0];
                 var novoNo = new No(_.extend(no.attrs, {package: pacotes[0]}));
                 this.packages[pacotes[0]] = novoNo;
             } else if( pacotes[0]!='' ){ 
                 no.package = no.package.split('.').splice(1).join('.');
                 var novoNo = new No(_.extend(no.attrs, {package: pacotes[0]}));
                 this.packages[pacotes[0]] = novoNo;
                 this.packages[pacotes[0]].adicionar(no);
             } else {
                 if(no.attrs.classes.length > 0){
                     var fullClassName = no.attrs.classes[0].name.split('.');
                     var className = fullClassName[fullClassName.length-1]
                     
                     var novoNo = new No(_.extend(no.attrs, {package: pacotes[0]}));
                     this.classes[className] = novoNo;
                     novoNo.updateClass2DSize()
                 }
             }             
             
         }
         
         function Arvore(dados){
             this.raiz = new No(); 
         }
         
        Arvore.prototype.addNo = function(dado){
            var novoNo = new No(dado);
            this.raiz.adicionar(novoNo);
        }
        
        Arvore.prototype.calcularPosicoes = function(){
            this.raiz.calcularPosicoes(this.raiz);
            calcularBin({h:0, w:0, classes:{raiz:this.raiz}, packages: {}});
        }
         
         var arvore  = new Arvore();
         
         dados.forEach(function(classe){
            arvore.addNo(classe) 
         });         
         arvore.calcularPosicoes();
  
         

         var scene,renderer;
 var width = window.innerWidth;
 var height = window.innerHeight;
 
 var raycaster = new THREE.Raycaster();  
 var camera = new THREE.PerspectiveCamera(55, width / height, 0.1, 100000000000);
 var objetos = [];
    
function plotBildings(espaco, no, nivel){
  //  if(nivel == 3){
    var classes = _.values(no.classes);
                 for(var i=0; i<classes.length; i++){
                     //console.log(nivel, packages[i])
                     espaco.add(criarpredio(classes[i], nivel))
                 }
 //   }
                 
}         
function plotPackage2(espaco, no, nivel, parent){
            if(no.fit && _.values(no.packages).length == 0){
                 //console.log(parentNo.package)
                //console.log(2,no) 
                var bairro = criarbairro(no, nivel, parent);
                espaco.add(bairro, nivel)
                
                plotBildings(espaco, no, nivel)
                
             } else if (no.fit){
                 
                 var bairro = criarbairro(no, nivel, parent);
                 espaco.add(bairro)
                 plotBildings(espaco, no, nivel)
                 
                 console.log(no.package, nivel)
                 
                 var packages = _.values(no.packages);
                 
                 nivel = nivel+1;
                 for(var i=0; i<packages.length; i++){
                     //console.log(nivel, packages[i])
                     this.plotPackage2(bairro, packages[i], nivel, parent)
                 }
     
                 
             }  
}         
function plotPackage(espaco, raiz){
            var packages = _.values(raiz.packages);
            for(var i=0; i<packages.length; i++){
                     this.plotPackage2(espaco, packages[i], 2, raiz)                     
             }  
}  
         
function criarpredio(no, nivel){
    
    if(!no.fit){
        console.log("TESTE".no);
      return;  
    } 
    
    geometry = new THREE.BoxGeometry( no.w-50, nivel*200, no.h-50 );
    geometry.applyMatrix(new THREE.Matrix4().makeTranslation(0,0, 0));

    var material = new THREE.MeshLambertMaterial({color:0x2f9dbd});
	
    
    
    let predio = new THREE.Mesh( geometry,material);
    
   
    predio.position.z = no.fit.y;
    predio.position.x = no.fit.x;
    
    //console.log(nome,predio.position.x,predio.position.z)
    
    predio.no = no;
    
    predio.position.y = (nivel*200/2)+(nivel*5);
    predio.scale.set(1,1,1);
    predio.name = "asdsada";
    predio.conteudo = "Classe: "+no.attrs.filename  + " x: " + predio.position.x;
    objetos.push(predio);
    
    return predio;
}            
         
function criarbairro(no, nivel, parent)
{
console.log(nivel)
    var geometry = new THREE.BoxGeometry(no.w,nivel*5,no.h);
    
    var cor = Math.random() * 0xfffbcc ;
    var material = new THREE.MeshLambertMaterial({ color: cor});
    
    geometry.applyMatrix(new THREE.Matrix4().makeTranslation(0,0,0));
    
    var bairro = new THREE.Mesh(geometry, material);
    
    //bairro.position.set(-600,10,-700);
    largura = 600;
    //bairro.position.x = (0 - ( 1800 - largura )/2 ) //no.fit.x - (parent.w - no.w)/4 ;
   //bairro.position.z = (0 - (2000 - largura) /2 ) //no.fit.y - 1 * parent.w + 1;
    bairro.position.z = no.fit.y;
    bairro.position.x = no.fit.x;
    
    
    bairro.no = no;
    bairro.position.y = nivel*5;
    bairro.scale.set(1,1,1);
    bairro.name = no.package;
    bairro.conteudo = "Pacote: "+ no.package + " x: " + bairro.position.x;

    objetos.push(bairro);
    
    return bairro;

}
    
function init(no) {
    
    

	scene = new THREE.Scene();
    
    renderer = new THREE.WebGLRenderer({ antialias: true});
    renderer.setClearColor(0xcccccc);
    renderer.setSize(width, height);
    renderer.setPixelRatio( window.devicePixelRatio );
    document.getElementById("cidade").appendChild(renderer.domElement);
    
    
    camera.position.set(0, 2070, 5500);
    
    
    luz = new THREE.AmbientLight(0xFFFFFF,0.5);
    
    luz2 = new THREE.PointLight(0xFFFFFF,0.5);
    
    scene.add(luz);
    scene.add(luz2);
    scene.add(camera);
    
    var cidade = criarcidade(no);  
    plotPackage(cidade, no);
    
    
    
    scene.add(cidade);
   

    const controls = new THREE.OrbitControls( camera, renderer.domElement );
    
    animate();
    window.addEventListener('mousemove',acaomovimentacaomouse,false);

    window.addEventListener( 'resize', onResize );
        
        
}
         
init(arvore.raiz);            
function criarcidade(no){
    
    var geometry = new THREE.BoxGeometry(no.w,10,no.h);
    var material = new THREE.MeshBasicMaterial( {color: 0xFFFFFF} );
  
    geometry.applyMatrix(new THREE.Matrix4().makeTranslation(0.5, 0.5, 0.5));
    
    var cidade = new THREE.Mesh(geometry, material);
    
    cidade.position.set(0,0,0);
    cidade.scale.set(1,1,1);
    
    var geo = new THREE.EdgesGeometry( geometry ); // or WireframeGeometry( geometry )

    var mat = new THREE.LineBasicMaterial( { color: 0xCCCCCC, linewidth: 2 } );

    var wireframe = new THREE.LineSegments( geo, mat );

    scene.add( wireframe );
    
    cidade.name = "cidade"
    
    return cidade;
}
         
         var objetoanterior;
var dadosclasse = document.createElement("div");
function acaomovimentacaomouse(e){
    e.preventDefault();
    
    var raycaster = new THREE.Raycaster(); // create once and reuse
    var mouse = new THREE.Vector2(); // create once and reuse

mouse.x = ( e.clientX / renderer.domElement.clientWidth ) * 2 - 1;
mouse.y = - ( e.clientY / renderer.domElement.clientHeight ) * 2 + 1;

raycaster.setFromCamera( mouse, camera );

var intersects = raycaster.intersectObjects( objetos );
    

if ( intersects.length > 0 ) {
    
    if(objetoanterior != intersects[0].object ){
        
      console.log(intersects[0].object)
        
        if(objetoanterior){
            objetoanterior.material.color.set(objetoanterior.currentHex);
        }
            objetoanterior = intersects[0].object;   
            objetoanterior.currentHex = objetoanterior.material.color.getHex();
            if(intersects[0].object.name != "cidade" ){
               objetoanterior.material.color.set(0xFF0000);
                console.log(e.clientY);
                
                dadosclasse.innerHTML = objetoanterior.conteudo;
                dadosclasse.style = "position:fixed;top:"+(e.clientY)+"px;left:"+(e.clientX+20)+"px;background-color:rgba(255,255,255,.85);width:250px;min-height:100px;border:1px solid #666;padding: 10px;";
                document.getElementById("cidade").appendChild(dadosclasse);
                
                
            }else{
                dadosclasse.style = "display:none;"        
            }
        
    }
    
        
}else{
    if(objetoanterior){
        objetoanterior.material.color.set(objetoanterior.currentHex);
        dadosclasse.style = "display:none;"
    }
    objetoanterior = null;
    
}
    
    
     
    
    
   
}


function onResize() {

	camera.aspect = window.innerWidth / window.innerHeight;
	camera.updateProjectionMatrix();
	renderer.setSize( window.innerWidth, window.innerHeight );

    
    
    
}

function animate() {

	requestAnimationFrame( animate );
    render();
  
}
function render(){
    renderer.render( scene, camera );
                
}

    </script>    
        
        
        
        
       
               
    
    </body>
</html>